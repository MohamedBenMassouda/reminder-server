name: Prepare stable PR description

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare-description:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine PR context
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "BASE_REF=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          echo "HEAD_REF=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

      # Case A: master -> stable (release PR)
      - name: Build description from merged PRs (master -> stable)
        if: ${{ env.HEAD_REF == 'testing' }}
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x .github/scripts/prepare-pr-description.sh
          .github/scripts/prepare-pr-description.sh

      # Case B: standalone PR directly to stable
      - name: Build description from commit messages (standalone PR)
        if: ${{ env.HEAD_REF != 'testing' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ env.PR_NUMBER }}

          COMMITS_JSON=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/commits)
          BODY_FILE="pr-body-generated.md"

          echo "## Changes" > "$BODY_FILE"
          echo "" >> "$BODY_FILE"

          echo "$COMMITS_JSON" \
            | jq -r '.[] | "- " + .commit.message' \
            >> "$BODY_FILE"

          # If there is already a PR body, prepend a note instead of nuking it
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body --jq .body)

          if [ -n "$CURRENT_BODY" ] && [ "$CURRENT_BODY" != "null" ]; then
            echo "$CURRENT_BODY" > existing_body.md
            echo "" >> existing_body.md
            echo "---" >> existing_body.md
            echo "" >> existing_body.md
            cat "$BODY_FILE" >> existing_body.md
            mv existing_body.md "$BODY_FILE"
          fi

          gh pr edit $PR_NUMBER --body-file "$BODY_FILE"
