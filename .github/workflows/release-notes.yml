name: Send Release notes to Teams

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  contents: write

jobs:
  release-notes:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tags
        run: |
          echo "CURR_TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Write PR body to file
        run: |
          cat << 'EOF' > release-notes.md
          ${{ github.event.pull_request.body }}
          EOF

      - name: Make script executable
        run: chmod +x .github/scripts/rewrite-and-send.sh

      - name: Rewrite notes and send to Teams
        env:
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          GH_MODEL: ${{ secrets.GH_MODEL }}
          CURR_TAG: ${{ env.CURR_TAG }}
        run: |
          .github/scripts/rewrite-and-send.sh
