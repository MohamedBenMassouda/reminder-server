name: Release notes to Teams

on:
  workflow_run:
    workflows: ["Auto Tag"]
    types:
      - completed

permissions:
  contents: write

jobs:
  release-notes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tags
        run: |
          echo "CURR_TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Generate Release Notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create --generate-notes --latest $CURR_TAG

      - name: Get release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release view $CURR_TAG --json body -q .body > release-notes.md

      - name: Make script executable
        run: chmod +x .github/scripts/rewrite-and-send.sh

      - name: Rewrite notes and send to Teams
        env:
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          GH_MODEL: ${{ secrets.GH_MODEL }}
          CURR_TAG: ${{ env.CURR_TAG }}
        run: |
          .github/scripts/rewrite-and-send.sh
