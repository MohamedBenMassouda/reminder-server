name: Auto Tag

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump calendar version yyyy-MM.release
        run: |
          # Current year-month prefix, e.g. "2025-12"
          CURRENT_PREFIX=$(date +'%Y-%m')
          echo "Current prefix: $CURRENT_PREFIX"

          # Find the latest tag for this month: "YYYY-MM.*"
          LAST_TAG=$(git tag --list "${CURRENT_PREFIX}.*" | sort -V | tail -n 1 || true)
          echo "Last tag for this month: ${LAST_TAG:-<none>}"

          if [ -z "$LAST_TAG" ]; then
            # No tag yet for this month â†’ start at 1
            RELEASE=1
          else
            # Extract the release number after the last dot
            LAST_RELEASE=${LAST_TAG##*.}
            # Safety: default to 0 if parsing fails
            if ! echo "$LAST_RELEASE" | grep -Eq '^[0-9]+$'; then
              echo "Warning: last release '$LAST_RELEASE' is not a number, defaulting to 0"
              LAST_RELEASE=0
            fi
            RELEASE=$((LAST_RELEASE + 1))
          fi

          NEW_TAG="${CURRENT_PREFIX}.${RELEASE}"
          echo "New tag: $NEW_TAG"

          # Create and push the new tag
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

